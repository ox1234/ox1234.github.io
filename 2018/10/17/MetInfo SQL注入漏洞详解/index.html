<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="flight"><link rel="alternative" href="/atom.xml" title="技术改变世界，文化改变人心" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>MetInfo SQL注入漏洞详解 - 技术改变世界，文化改变人心</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">技术改变世界，文化改变人心</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-10-17T03:17:26.454Z">October 17, 2018</time><h1 class="post__title"><a href="/2018/10/17/MetInfo SQL注入漏洞详解/">MetInfo SQL注入漏洞详解</a></h1><div class="post__main echo"><h1 id="MetInfo-SQL注入漏洞详解"><a href="#MetInfo-SQL注入漏洞详解" class="headerlink" title="MetInfo SQL注入漏洞详解"></a>MetInfo SQL注入漏洞详解</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前CNVD爆出了一个最新版本的MetInfoSQL注入漏洞，根据payload正向分析了一遍漏洞原理，写一篇详细一点的</p>
<h2 id="参数回溯"><a href="#参数回溯" class="headerlink" title="参数回溯"></a>参数回溯</h2><p>payload: <code>admin/index.php?m=web&amp;n=message&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1&amp;para138=1&amp;para139=1&amp;para140=1&amp;id=42 and 1=1</code></p>
<p>需要在管理员页面触发，为一个bool类型的SQL盲注</p>
<p>问题出现在/app/message/web/message.class.php中的add函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//message类</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($info)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">if</span>(!$_M[form][id])&#123;</span><br><span class="line">           $message=DB::get_one(<span class="string">"select * from &#123;$_M[table][column]&#125; where module= 7 and lang ='&#123;$_M[form][lang]&#125;'"</span>);</span><br><span class="line">           $_M[form][id]=$message[id];</span><br><span class="line">		&#125;</span><br><span class="line">		$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line">        $_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line">		<span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);</span><br><span class="line">		<span class="keyword">if</span>($_M[config][met_memberlogin_code])&#123;</span><br><span class="line">			<span class="keyword">if</span>(!load::sys_class(<span class="string">'pin'</span>, <span class="string">'new'</span>)-&gt;check_pin($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">			 			okinfo(<span class="number">-1</span>, $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">	    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在第七行处的<code>$_M[form][id]</code>并没有被单引号包裹，出现了SQL注入漏洞，我们再回溯变量看看<code>$_M[form][id]</code>是从哪里来的，可以看到第二行定义了全局变量<code>$_M</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//message类</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upfile = load::sys_class(<span class="string">'upfile'</span>, <span class="string">'new'</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>并且在message的构造方法中也定义了<code>$_M</code>，且未初始化，判断$_M在message的构造方法中被赋值，在构造方法中还调用了父类的<code>__construct</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//web类</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="comment">// 可视化窗口语言栏跳转后，整个可视化页面跳转到新语言</span></span><br><span class="line">		<span class="keyword">if</span>(strpos($_SERVER[<span class="string">'HTTP_REFERER'</span>], <span class="string">'pageset=1'</span>)!==<span class="keyword">false</span> &amp;&amp; strpos($_SERVER[<span class="string">'HTTP_REFERER'</span>], <span class="string">'lang='</span>)!==<span class="keyword">false</span> &amp;&amp; strpos($_SERVER[<span class="string">'HTTP_REFERER'</span>], $_M[<span class="string">'url'</span>][<span class="string">'site'</span>])!==<span class="keyword">false</span>)&#123;</span><br><span class="line">			preg_match(<span class="string">'/lang=(\w+)/'</span>, $_SERVER[<span class="string">'HTTP_REFERER'</span>], $prev_lang);</span><br><span class="line">			<span class="keyword">if</span>($prev_lang &amp;&amp; $prev_lang[<span class="number">1</span>] !=$_M[<span class="string">'lang'</span>])&#123;</span><br><span class="line">				$new_url=<span class="string">"&#123;$_M['url']['site_admin']&#125;index.php?lang=&#123;$_M['lang']&#125;&amp;n=ui_set&amp;pageset=1"</span>;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">					parent.document.getElementsByClassName('page-iframe')[0].setAttribute('data-dynamic','&#123;$_M['url']['site']&#125;index.php?lang=&#123;$_M['lang']&#125;');</span></span><br><span class="line"><span class="string">					parent.window.location.href='&#123;$new_url&#125;';</span></span><br><span class="line"><span class="string">				&lt;/script&gt;"</span>;</span><br><span class="line">				<span class="keyword">die</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>在web类的构造方法中并没有发现对<code>$_M</code>的赋值操作，而且web类又调用了父类的构造方法，继续回溯web类父类的构造方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//common类</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;<span class="comment">//全局数组$_M</span></span><br><span class="line">		ob_start();<span class="comment">//开启缓存</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_mysql();<span class="comment">//数据库连接</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_form();<span class="comment">//表单过滤</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_lang();<span class="comment">//加载语言配置</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_config_global();<span class="comment">//加载全站配置数据</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_url_site();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_config_lang();<span class="comment">//加载当前语言配置数据</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;load_url();<span class="comment">//加载url数据</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在这里的load_form函数中对传入的GPC参数进行了过滤和赋值，并且将处理过的GPC转存到<code>$_M</code>中</p>
<p>至此，我们找到了<code>$_M</code>赋值的地方，此时类的继承关系为：<code>common-&gt;web-&gt;message</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		$_M[<span class="string">'form'</span>] =<span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">isset</span>($_REQUEST[<span class="string">'GLOBALS'</span>]) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Error'</span>);</span><br><span class="line">		<span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">			$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">			$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">			$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(is_numeric($_M[<span class="string">'form'</span>][<span class="string">'lang'</span>]))&#123;<span class="comment">//伪静态兼容</span></span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'page'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>];</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'lang'</span>] = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'metid'</span>] == <span class="string">'list'</span>)&#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'list'</span>] = <span class="number">1</span>;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'metid'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'page'</span>];</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'page'</span>] = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">'/^[0-9A-Za-z]+$/'</span>, $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>]) &amp;&amp; $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>])&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"No data in the database,please reinstall."</span>;</span><br><span class="line">			<span class="keyword">die</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>load_form</code>函数中我们发现了赋值给<code>$_M</code>的过程和过滤函数daddslashes，跟入查看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对字符串进行反斜杠处理，如果服务器开启MAGIC_QUOTES_GPC。则不处理。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string/array	$string	处理的字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool			$force	是否强制反斜杠处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array                返回处理好的字符串或数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span><span class="params">($string, $force = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">	!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());</span><br><span class="line">	<span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = daddslashes($val, $force);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(!defined(<span class="string">'IN_ADMIN'</span>))&#123;</span><br><span class="line">				$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$string = trim(addslashes($string));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在没有定义<code>IN_ADMIN</code>的时候在addslashes之前还调用了sqlinsert函数，这也就是为什么作者说在第一次尝试注入的时候发现SQL关键词都被清除了，所以我们需要找到一个地方定义了<code>IN_ADMIN</code>来绕过sqlinsert函数</p>
<h2 id="正向分析"><a href="#正向分析" class="headerlink" title="正向分析"></a>正向分析</h2><p>即然我们需要<code>IN_ADMIN</code>值不为false，根据字面意思判断，就可以知道需要在管理页面找，而admin/index.php正好定义了<code>IN_ADMIN</code>的值</p>
<p><img src="http://120.77.152.169/upload/17d86442d803c680bfde184711232829.png" alt=""></p>
<p>而且在此文件中我们可以更改GET参数来调用各种模型，类名，操作名(操作名必须以do开头)</p>
<p>作者找到了domessage函数可以触发add方法，并且将GET的参数全部传递过去，成功注入，鉴于里面的逻辑太复杂，直接使用xdebug跟踪函数调用</p>
<p>输入payload之后直接跟到调用add函数的位置，可以在PHPstorm中看到所有的函数调用关系</p>
<p><img src="http://120.77.152.169/upload/42f8a91949507f05e3f69ce15232389f.png" alt=""></p>
<p>在<code>_load_class</code>中实例化了message类</p>
<p><img src="http://120.77.152.169/upload/22d6d7bed615e5422928dcd7088dc545.png" alt=""></p>
<p>在实例化的时候调用message类的构造方法，调用了message父类web的父类common的构造方法，并且使用了<code>load_form</code>过滤了传入的GPC参数，这个地方在跟踪的时候发现居然跳到了web类中实现的<code>load_form</code>函数，刚开始有点迷，后来想清楚了</p>
<p>在学面向对象的时候继承是一个很重要的概念，而这个时候就是面向对象的一个特性，此时调用方法是：<code>$this-&gt;load_form();//表单过滤</code>，可以看到当前的\$this指向的是message类，这个时候去message类找<code>load_form()</code>函数，发现没有这个函数，根据继承的特性，程序向message类的父类去找<code>load_form()</code>函数，发现它的父类实现了<code>load_form</code>，所以直接调用message父类的<code>load_form</code>，而这个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	  * 重写common类的load_form方法，前台对提交的GET，POST，COOKIE进行安全的过滤处理</span></span><br><span class="line"><span class="comment">	  */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">parent</span>::load_form();</span><br><span class="line">		<span class="keyword">foreach</span> ($_M[<span class="string">'form'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][$key] = sqlinsert($val);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'id'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'id'</span>])) &#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'id'</span>] = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class1'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class1'</span>])) &#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'class1'</span>] = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class2'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class2'</span>])) &#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'class2'</span>] = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($_M[<span class="string">'form'</span>][<span class="string">'class3'</span>]!=<span class="string">''</span> &amp;&amp; !is_numeric($_M[<span class="string">'form'</span>][<span class="string">'class3'</span>])) &#123;</span><br><span class="line">			$_M[<span class="string">'form'</span>][<span class="string">'class3'</span>] = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里对每一个table传入的参数进行一次sqlinsert过滤，按理来说我们的payload已经被过滤了，通过监视<code>$_M</code>，确实我们的payload已经为空了</p>
<p><img src="http://120.77.152.169/upload/0bf72f4dba5ac8925d9ab1f2952bd876.png" alt=""></p>
<p>但是为什么我们的payload最后还能执行呢，再跟踪函数，我发现在调用完web类的<code>load_form</code>函数之后，调用了<code>$this-&gt;upfile = load::sys_class(&#39;upfile&#39;, &#39;new&#39;);</code>，在这个函数中又重新调用了common的构造方法，结果把payload又赋值给了<code>$_M</code></p>
<p><img src="http://120.77.152.169/upload/a64a6ce8beaa7c517933d8832f018854.png" alt=""></p>
<p>这个时候我们的payload又回到了<code>$_M</code>的id参数中</p>
<p>这个时候，可以确定payload可以拼接入SQL语句中，但是接下来还需要将所有逻辑走通，接下来解答几个问题</p>
<h3 id="为什么需要paraXXX参数"><a href="#为什么需要paraXXX参数" class="headerlink" title="为什么需要paraXXX参数"></a>为什么需要paraXXX参数</h3><p>在执行domessage函数的时候，可以看到在执行add函数之前执行了一个check_field函数，我们进入查看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_field</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $_M;</span><br><span class="line">        $messagecfg= load::mod_class(<span class="string">'message/message_handle'</span>,<span class="string">'new'</span>)-&gt;get_message_config(load::mod_class(<span class="string">'message/message_database'</span>,<span class="string">'new'</span>)-&gt;get_message_columnid());</span><br><span class="line">        $met_message_fd_class=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_class][value]];</span><br><span class="line">        $met_message_fd_content=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_content][value]];</span><br><span class="line">        $met_message_fd_email=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_email][value]];</span><br><span class="line">        $met_message_fd_sms=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_sms][value]];</span><br><span class="line">        $met_fd_back=$messagecfg[met_fd_back][value];</span><br><span class="line">        $paralist=load::mod_class(<span class="string">'parameter/parameter_database'</span>,<span class="string">'new'</span>)-&gt;get_parameter(<span class="string">'7'</span>);</span><br><span class="line">        <span class="keyword">foreach</span> ($paralist <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        	$para[$val[id]]=$val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       $paraarr = <span class="keyword">array</span>();</span><br><span class="line">       <span class="keyword">foreach</span> (array_keys($_M[<span class="string">'form'</span>]) <span class="keyword">as</span> $vale) &#123;</span><br><span class="line">           <span class="keyword">if</span> (strstr($vale, <span class="string">'para'</span>)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (strstr($vale, <span class="string">'_'</span>)) &#123;</span><br><span class="line">                   $arr = explode(<span class="string">'_'</span>,$vale);</span><br><span class="line">                   $paraarr[] = str_replace(<span class="string">'para'</span>,<span class="string">''</span>,$arr[<span class="number">0</span>]);</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   $paraarr[] = str_replace(<span class="string">'para'</span>,<span class="string">''</span>,$vale);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">foreach</span> (array_keys($para) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">           <span class="keyword">if</span>($para[$val][<span class="string">'wr_ok'</span>]==<span class="number">1</span> &amp;&amp; !in_array($val,$paraarr))&#123;</span><br><span class="line">               $info=<span class="string">"【&#123;$para[$val]['name']&#125;】"</span>.$_M[word][noempty];</span><br><span class="line">               okinfo(<span class="string">'javascript:history.back();'</span>,$info);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="comment">//met_message_fd_class  姓名</span></span><br><span class="line">        <span class="comment">//met_message_fd_content 留言内容</span></span><br><span class="line">        <span class="comment">//met_message_fd_email  邮箱</span></span><br><span class="line">        <span class="comment">// met_message_fd_sms 电话</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>下面这些变量就是我们传入参数中paraXXX的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$met_message_fd_class=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_class][value]];</span><br><span class="line">$met_message_fd_content=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_content][value]];</span><br><span class="line">$met_message_fd_email=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_email][value]];</span><br><span class="line">$met_message_fd_sms=$_M[form][<span class="string">'para'</span>.$messagecfg[met_message_fd_sms][value]];</span><br><span class="line">$met_fd_back=$messagecfg[met_fd_back][value];</span><br></pre></td></tr></table></figure>
<p>这一行<code>if($para[$val][&#39;wr_ok&#39;]==1 &amp;&amp; !in_array($val,$paraarr))</code>判断了我们传入的参数中有无paraXXX</p>
<p><img src="http://120.77.152.169/upload/8b683b8eb9c93c0957ae6e05532bebd7.png" alt=""><br><img src="http://120.77.152.169/upload/7fef585a86b7727f2c69e244570c207a.png" alt=""></p>
<p>我们需要在传入的参数中有137,186,138,139,140，否则会进入if条件中的逻辑</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$info=<span class="string">"【&#123;$para[$val]['name']&#125;】"</span>.$_M[word][noempty];</span><br><span class="line">okinfo(<span class="string">'javascript:history.back();'</span>,$info);</span><br></pre></td></tr></table></figure>
<h3 id="为什么id必须为42"><a href="#为什么id必须为42" class="headerlink" title="为什么id必须为42"></a>为什么id必须为42</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line">$_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line"><span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);</span><br></pre></td></tr></table></figure>
<p>可以看到，从数据库中取出<code>$_met_fd_ok</code>的值，如果<code>$_met_fd_ok[value]</code>不为空的话，继续往下执行，我们进入数据库看看这条语句到底取出来的是哪些值</p>
<p><img src="http://120.77.152.169/upload/cb64d8bb19675644252aefd9e3d2cd3d.png" alt=""></p>
<p>可以看到我们想让它的返回不为空，id的值必须为42或者44，所以我们的注入的时候必须保证id的值为44或者42</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>metinfo的SQL注入漏洞是作者在几次给metinfo提交后met官方不予理睬才曝光的，希望厂商能多多重视安全吧</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/漏洞分析/">漏洞分析</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/安全技术/">安全技术</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 flight</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>