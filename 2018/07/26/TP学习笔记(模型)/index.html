<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="flight"><link rel="alternative" href="/atom.xml" title="技术改变世界，文化改变人心" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>TP框架学习笔记(控制器) - 技术改变世界，文化改变人心</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">技术改变世界，文化改变人心</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-07-26T05:41:18.062Z">July 26, 2018</time><h1 class="post__title"><a href="/2018/07/26/TP学习笔记(模型)/">TP框架学习笔记(控制器)</a></h1><div class="post__main echo"><h1 id="TP学习笔记-模型"><a href="#TP学习笔记-模型" class="headerlink" title="TP学习笔记(模型)"></a>TP学习笔记(模型)</h1><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><h3 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h3><p>模型不是必须定义的，只有当存在额外的逻辑或者属性的时候才需要定义，TP约定的模型命名规则是去除表前缀的数据表名称，使用首字母大写的格式再加上Model</p>
<p>eg: 数据表名称为<code>think_user</code>，则它的模型名称为<code>UserModel</code></p>
<h3 id="模型实例化"><a href="#模型实例化" class="headerlink" title="模型实例化"></a>模型实例化</h3><ul>
<li><p>new实例化</p>
<p>  模型本质也是PHP的类，所以可以直接用new实例化</p>
<p>  eg: <code>$user =new Model(&#39;User&#39;);</code></p>
<p>  Model类的构造方法有三个参数(去除表前缀的数据表名称，表前缀，连接配置）</p>
</li>
<li><p>M函数实例化</p>
<p>  M函数为model函数的简写，和Model类的构造方法相同</p>
</li>
<li><p>D函数实例化</p>
<p>  D和M的区别：D函数可以自动检测模型类，如果存在指定模型类，则实例化该模型类，否则实例化”Think\Model”类，而M函数只会实例化”Think\Model”类</p>
</li>
<li><p>空模型实例化</p>
<p>  如果只需要执行SQL，不需要其他操作的话，可以实例化一个空模型类</p>
<p>  eg: </p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> Model(); <span class="comment">//等效于 $m = M();</span></span><br><span class="line">$data = $m-&gt;query(<span class="string">'SELECT * FROM c5_User'</span>);</span><br><span class="line">print_r($data);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="连贯操作"><a href="#连贯操作" class="headerlink" title="连贯操作"></a>连贯操作</h3><p>若是需要查询User模型中的status为1的前10条记录，并且按照时间倒序排序，可以通过如下代码实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$user = M(<span class="string">'User'</span>);</span><br><span class="line">$list = $user-&gt;where(<span class="string">'status=1'</span>)-&gt;order(<span class="string">'create_time desc'</span>)-&gt;limit(<span class="number">10</span>)-&gt;select();</span><br></pre></td></tr></table></figure>
<p>常用的支持连贯操作的方法</p>
<ol>
<li>where: 支持字符串，数组和对象</li>
<li>alias: 设置当前数据表的别名</li>
<li>data: 用来设置当前模型需要操作的数据，未经$model-&gt;create()方法处理过的数据，TP不能直接使用</li>
</ol>
<p>比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'zhangsan'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'111111'</span></span><br><span class="line">);</span><br><span class="line">$model-&gt;add($data);</span><br></pre></td></tr></table></figure>
<p>上面这一段代码会报错，因为没有经过model-&gt;create()方法处理</p>
<p>改为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'zhangsan'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'111111'</span></span><br><span class="line">);</span><br><span class="line">$model-&gt;create($data);</span><br><span class="line">$model-&gt;add($data);</span><br></pre></td></tr></table></figure>
<p>使用data方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'zhangsan'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'111111'</span></span><br><span class="line">);</span><br><span class="line">M(<span class="string">'User'</span>)-&gt;data($data)-&gt;add();</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>field: 用来选择需要返回的字段</li>
<li>order: 用来排序</li>
<li>limit: 用来限制返回结果的数量</li>
<li>page: 分页操作</li>
<li>group: 结果分组</li>
<li>having: 筛选经过group分组以后且满足条件的数据集</li>
<li>join: 进行连表查询</li>
</ol>
<h3 id="CURD操作"><a href="#CURD操作" class="headerlink" title="CURD操作"></a>CURD操作</h3><p>C：create，插入数据<br>U：update，更新数据<br>R：read，读取数据<br>D：delete，删除数据</p>
<h4 id="创建数据"><a href="#创建数据" class="headerlink" title="创建数据"></a>创建数据</h4><p>自动根据表单POST数据创建数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$user = M(<span class="string">'User'</span>);</span><br><span class="line">$user-&gt;create(); <span class="comment">//该代码会自动读取post中的数据</span></span><br></pre></td></tr></table></figure>
<p>从数组创建数据对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'zhangsan'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'111111'</span></span><br><span class="line">);</span><br><span class="line">$user = M(<span class="string">'User'</span>);</span><br><span class="line">$user-&gt;create($data);</span><br></pre></td></tr></table></figure>
<p>create方法的第二个参数知指明该操作时插入还是更新操作</p>
<p>注：create操作产生的数据并没有真正写入数据库，而是再屌用add或者save方法以后才会操作数据库</p>
<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><p>TP插入数据使用add方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'zhangsan'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'111111'</span></span><br><span class="line">);</span><br><span class="line">$user = M(<span class="string">'User'</span>);</span><br><span class="line">$user-&gt;create($data)-&gt;add();</span><br></pre></td></tr></table></figure>
<h4 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h4><p>TP可以读取字段值，单条数据，数据集</p>
<h5 id="读取字段值"><a href="#读取字段值" class="headerlink" title="读取字段值"></a>读取字段值</h5><p>使用getField方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$score = $model-&gt;where(<span class="string">'id=3'</span>)-&gt;getField(<span class="string">'score'</span>);</span><br></pre></td></tr></table></figure>
<h5 id="读取单条数据"><a href="#读取单条数据" class="headerlink" title="读取单条数据"></a>读取单条数据</h5><p>使用find方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法1:</span></span><br><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model-&gt;find(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//方法2:</span></span><br><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model-&gt;where(<span class="string">'id=1'</span>)-&gt;find();</span><br></pre></td></tr></table></figure>
<h6 id="读取数据集"><a href="#读取数据集" class="headerlink" title="读取数据集"></a>读取数据集</h6><p>使用select方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model-&gt;where(<span class="string">'score &gt; 100'</span>)-&gt;select();</span><br></pre></td></tr></table></figure>
<h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><p>TP中的数据更新包括更新记录和更新字段</p>
<h5 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h5><p>使用save方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'nickname'</span> =&gt; <span class="string">'hehe'</span></span><br><span class="line">);</span><br><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model = create($data);</span><br><span class="line">$model = where(<span class="string">'id=1'</span>).save($data);</span><br></pre></td></tr></table></figure>
<h5 id="更新字段"><a href="#更新字段" class="headerlink" title="更新字段"></a>更新字段</h5><p>使用setField方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新字段</span></span><br><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model-&gt;where(<span class="string">'id=1'</span>)-&gt;setField(<span class="string">'score'</span>,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新统计字段</span></span><br><span class="line">$model = M(<span class="string">'User'</span>);</span><br><span class="line">$model-&gt;where(<span class="string">'id=1'</span>)-&gt;setDec(<span class="string">'score'</span>,<span class="number">100</span>);</span><br><span class="line">$model = M(<span class="string">'Article'</span>);</span><br><span class="line">$model-&gt;where(<span class="string">'id=1'</span>)-&gt;setInc(<span class="string">'views'</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><p>使用delete方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$model = M(<span class="string">'Article'</span>);</span><br><span class="line">$model-&gt;delete(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>注：为了避免错删数据，如果没有任何条件进行删除操作的话，不会执行删除操作</p>
<h3 id="自动验证"><a href="#自动验证" class="headerlink" title="自动验证"></a>自动验证</h3><p>数据验证有两种方式：</p>
<ul>
<li>静态方式：在模型类中通过<code>$_validate</code>定义</li>
<li>动态方式：使用模型类的validate方法</li>
</ul>
<p>验证规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array(</span><br><span class="line">	array(字段名,验证规则,错误提示,[验证条件,附加规则,验证场景])</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="自动完成"><a href="#自动完成" class="headerlink" title="自动完成"></a>自动完成</h3><p>自动完成的两种方式：</p>
<ul>
<li>静态方式：在模型里面通过<code>$_auto</code>属性定义处理机制</li>
<li>动态方式：使用模型类的auto方法动态创建自动处理机制</li>
</ul>
<ol>
<li><p>定义规则</p>
<p> 格式：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array(</span><br><span class="line">array(完成字段,完成规则,[完成条件,附加规则])</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>完成字段：需要完成的字段名<br>完成规则：以何种规则处理该字段<br>完成条件：可自动完成的条件(<code>self::MODEL_BOTH</code>,<code>self::MODEL_UPDATE</code>,<code>self::MODEL_INSERT</code>)</p>
<h3 id="视图模型"><a href="#视图模型" class="headerlink" title="视图模型"></a>视图模型</h3><p>视图一般指数据库的视图，视图是一个虚拟表，也有列和数据，视图常用来解决<code>HAS_ONE</code>和<code>BELONGS_TO</code>类型的关联查询</p>
<ol>
<li>继承ViewModel类</li>
<li><p>配置其中的$viewFields数组</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> $viewFields = <span class="keyword">array</span>(</span><br><span class="line">       <span class="string">'Post'</span> =&gt; <span class="keyword">array</span>(<span class="string">'post_id'</span>,<span class="string">'title'</span>,<span class="string">'content'</span>,<span class="string">'created_at'</span>,<span class="string">'updated_at'</span>),</span><br><span class="line">       <span class="string">'User'</span> =&gt; <span class="keyword">array</span>(<span class="string">'username'</span> =&gt; <span class="string">'author'</span>, <span class="string">'_on'</span> =&gt; <span class="string">'Post.user_id=User.id'</span>)</span><br><span class="line">   );</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="关联模型"><a href="#关联模型" class="headerlink" title="关联模型"></a>关联模型</h3><p>处理<code>HAS_MANY</code>之类的关系</p>
<p>关联关系包括：</p>
<ol>
<li>一对一</li>
<li>一对多</li>
<li>多对多</li>
</ol>
<p><code>HAS_ONE</code>,<code>BELONGS_TO</code>,<code>HAS_MANY</code>,<code>MANY_TO_MANY</code></p>
<p>要执行关联查询，模型类需要继承RelationModel，并且配置<code>$_link</code>属性</p>
<h4 id="HAS-ONE"><a href="#HAS-ONE" class="headerlink" title="HAS_ONE"></a>HAS_ONE</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> $_link = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'extra'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'mapping_type'</span> =&gt; <span class="keyword">self</span>::HAS_ONE,</span><br><span class="line">        <span class="string">'class_name'</span> =&gt; <span class="string">'UserExtra'</span>,</span><br><span class="line">        <span class="string">'foreign_key'</span> =&gt; <span class="string">'user_id'</span>,</span><br><span class="line">        <span class="string">'mapping_fields'</span> =&gt; <span class="string">'email,qq'</span></span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="BELONGS-TO"><a href="#BELONGS-TO" class="headerlink" title="BELONGS_TO"></a>BELONGS_TO</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> $_link = <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">'author'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">       <span class="string">'mapping_type'</span> =&gt; <span class="keyword">self</span>::BELONGS_TO,</span><br><span class="line">        <span class="string">'class_name'</span> =&gt; <span class="string">'User'</span>,</span><br><span class="line">        <span class="string">'foreign_key'</span> =&gt; <span class="string">'user_id'</span></span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/php/">php</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/tp/">tp</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 flight</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>